/*drivers/misc/lowmemorykiller.c**Thelowmemorykillerdriverletsuser-spacespecifyasetofmemorythresholds*whereprocesseswitharangeofoom_score_adjvalueswillgetkilled.Specify*theminimumoom_score_adjvaluesin*/sys/module/lowmemorykiller/parameters/adjandthenumberoffreepagesin*/sys/module/lowmemorykiller/parameters/minfree.Bothfilestakeacomma*separatedlistofnumbersinascendingorder.**Forexample,write"0,8"to/sys/module/lowmemorykiller/parameters/adjand*"1024,4096"to/sys/module/lowmemorykiller/parameters/minfreetokill*processeswithaoom_score_adjvalueof8orhigherwhenthefreememory*dropsbelow4096pagesandkillprocesseswithaoom_score_adjvalueof0or*higherwhenthefreememorydropsbelow1024pages.**Thedriverconsidersmemoryusedforcachestobefree,butifalarge*percentageofthecachedmemoryislockedthiscanbeveryinaccurate*andprocessesmaynotgetkilleduntilthenormaloomkilleristriggered.**Copyright(C)2007-2008Google,Inc.**ThissoftwareislicensedunderthetermsoftheGNUGeneralPublic*Licenseversion2,aspublishedbytheFreeSoftwareFoundation,and*maybecopied,distributed,andmodifiedunderthoseterms.**Thisprogramisdistributedinthehopethatitwillbeuseful,*butWITHOUTANYWARRANTY;withouteventheimpliedwarrantyof*MERCHANTABILITYorFITNESSFORAPARTICULARPURPOSE.Seethe*GNUGeneralPublicLicenseformoredetails.**/#include<linux/module.h>#include<linux/kernel.h>#include<linux/mm.h>#include<linux/oom.h>#include<linux/sched.h>#include<linux/rcupdate.h>#include<linux/notifier.h>#include<linux/mutex.h>#include<linux/delay.h>#include<linux/swap.h>#include<linux/fs.h>#include<linux/ratelimit.h>#defineLMK_COUNT_READ#ifdefLMK_COUNT_READstaticuint32_tlmk_count=0;#endif#ifdefCONFIG_SEC_OOM_KILLER#defineMULTIPLE_OOM_KILLER#defineOOM_COUNT_READ#endif#ifdefOOM_COUNT_READstaticuint32_toom_count=0;#endif#ifdefMULTIPLE_OOM_KILLER#defineOOM_DEPTH7#endifstaticuint32_tlowmem_debug_level=1;staticintlowmem_adj[6]={0,1,6,12,};staticintlowmem_adj_size=4;staticintlowmem_minfree[6]={3*512,/*6MB*/2*1024,/*8MB*/4*1024,/*16MB*/16*1024,/*64MB*/};staticintlowmem_minfree_size=4;staticunsignedlonglowmem_deathpending_timeout;#definelowmem_print(level,x...)\do{\if(lowmem_debug_level>=(level))\printk(x);\}while(0)#ifdefined(CONFIG_SEC_DEBUG_LMK_MEMINFO)staticvoiddump_tasks_info(void){structtask_struct*p;structtask_struct*task;pr_info("[pid]uidtgidtotal_vmrssswapcpuoom_adjoom_score_adjname\n");for_each_process(p){/*checkunkillabletasks*/if(is_global_init(p))continue;if(p->flags&PF_KTHREAD)continue;task=find_lock_task_mm(p);if(!task){/**Thisisakthreadorallofp'sthreadshavealready*detachedtheirmm's.There'snoneedtoreport*them;theycan'tbeoomkilledanyway.*/continue;}pr_info("[%5d]%5d%5d%8lu%8lu%8lu%3u%3d%5d%s\n",task->pid,task_uid(task),task->tgid,task->mm->total_vm,get_mm_rss(task->mm),get_mm_counter(task->mm,MM_SWAPENTS),task_cpu(task),task->signal->oom_adj,task->signal->oom_score_adj,task->comm);task_unlock(task);}}#endifstaticinttest_task_flag(structtask_struct*p,intflag){structtask_struct*t=p;do{task_lock(t);if(test_tsk_thread_flag(t,flag)){task_unlock(t);return1;}task_unlock(t);}while_each_thread(p,t);return0;}staticDEFINE_MUTEX(scan_mutex);#ifdefined(CONFIG_CMA_PAGE_COUNTING)#defineSSWAP_LMK_THRESHOLD(30720*2)#defineCMA_PAGE_RATIO70#endif#ifdefined(CONFIG_ZSWAP)externatomic_tzswap_pool_pages;externatomic_tzswap_stored_pages;#endifstaticintlowmem_shrink(structshrinker*s,structshrink_control*sc){structtask_struct*tsk;structtask_struct*selected=NULL;intrem=0;inttasksize;inti;intmin_score_adj=OOM_SCORE_ADJ_MAX+1;intselected_tasksize=0;intselected_oom_score_adj;#ifdefCONFIG_SAMP_HOTNESSintselected_hotness_adj=0;#endifintarray_size=ARRAY_SIZE(lowmem_adj);intother_free;intother_file;unsignedlongnr_to_scan=sc->nr_to_scan;#ifdefCONFIG_SEC_DEBUG_LMK_MEMINFOstaticDEFINE_RATELIMIT_STATE(lmk_rs,DEFAULT_RATELIMIT_INTERVAL,1);#endifunsignedlongnr_cma_free;structreclaim_state*reclaim_state=current->reclaim_state;#ifdefined(CONFIG_CMA_PAGE_COUNTING)unsignedlongnr_cma_inactive_file;unsignedlongnr_cma_active_file;unsignedlongcma_page_ratio;boolis_active_high;boolflag=0;#endifif(nr_to_scan>0){if(mutex_lock_interruptible(&scan_mutex)<0)return0;}other_free=global_page_state(NR_FREE_PAGES);nr_cma_free=global_page_state(NR_FREE_CMA_PAGES);#ifdefCONFIG_ZSWAPif(!current_is_kswapd()||sc->priority<=6)#endifother_free-=nr_cma_free;#ifdefined(CONFIG_CMA_PAGE_COUNTING)nr_cma_inactive_file=global_page_state(NR_CMA_INACTIVE_FILE);nr_cma_active_file=global_page_state(NR_CMA_ACTIVE_FILE);cma_page_ratio=100*global_page_state(NR_CMA_INACTIVE_FILE)/global_page_state(NR_INACTIVE_FILE);is_active_high=(global_page_state(NR_ACTIVE_FILE)>global_page_state(NR_INACTIVE_FILE))?1:0;#endifother_file=global_page_state(NR_FILE_PAGES);#ifdefined(CONFIG_CMA_PAGE_COUNTING)&&defined(CONFIG_EXCLUDE_LRU_LIVING_IN_CMA)if(get_nr_swap_pages()<SSWAP_LMK_THRESHOLD&&cma_page_ratio>=CMA_PAGE_RATIO&&!is_active_high){other_file=other_file-(nr_cma_inactive_file+nr_cma_active_file);flag=1;}#endifif(global_page_state(NR_SHMEM)+total_swapcache_pages<other_file)other_file-=global_page_state(NR_SHMEM)+total_swapcache_pages;elseother_file=0;if(lowmem_adj_size<array_size)array_size=lowmem_adj_size;if(lowmem_minfree_size<array_size)array_size=lowmem_minfree_size;for(i=0;i<array_size;i++){if(other_free<lowmem_minfree[i]&&other_file<lowmem_minfree[i]){min_score_adj=lowmem_adj[i];break;}}if(nr_to_scan>0)lowmem_print(3,"lowmem_shrink%lu,%x,ofree%d%d,ma%d\n",nr_to_scan,sc->gfp_mask,other_free,other_file,min_score_adj);rem=global_page_state(NR_ACTIVE_ANON)+global_page_state(NR_ACTIVE_FILE)+global_page_state(NR_INACTIVE_ANON)+global_page_state(NR_INACTIVE_FILE);if(nr_to_scan<=0||min_score_adj==OOM_SCORE_ADJ_MAX+1){lowmem_print(5,"lowmem_shrink%lu,%x,return%d\n",nr_to_scan,sc->gfp_mask,rem);if(nr_to_scan>0)mutex_unlock(&scan_mutex);returnrem;}selected_oom_score_adj=min_score_adj;rcu_read_lock();for_each_process(tsk){structtask_struct*p;intoom_score_adj;#ifdefCONFIG_SAMP_HOTNESSinthotness_adj=0;#endifif(tsk->flags&PF_KTHREAD)continue;/*iftasknolongerhasanymemoryignoreit*/if(test_task_flag(tsk,TIF_MM_RELEASED))continue;if(time_before_eq(jiffies,lowmem_deathpending_timeout)){if(test_task_flag(tsk,TIF_MEMDIE)){rcu_read_unlock();/*givethesystemtimetofreeupthememory*/msleep_interruptible(20);mutex_unlock(&scan_mutex);return0;}}p=find_lock_task_mm(tsk);if(!p)continue;oom_score_adj=p->signal->oom_score_adj;if(oom_score_adj<min_score_adj){task_unlock(p);continue;}tasksize=get_mm_rss(p->mm);#ifdefined(CONFIG_ZSWAP)if(atomic_read(&zswap_stored_pages)){lowmem_print(3,"showntasksize:%d\n",tasksize);tasksize+=atomic_read(&zswap_pool_pages)*get_mm_counter(p->mm,MM_SWAPENTS)/atomic_read(&zswap_stored_pages);lowmem_print(3,"realtasksize:%d\n",tasksize);}#endif#ifdefCONFIG_SAMP_HOTNESShotness_adj=p->signal->hotness_adj;#endiftask_unlock(p);if(tasksize<=0)continue;if(selected){#ifdefCONFIG_SAMP_HOTNESSif(min_score_adj<=lowmem_adj[4]){#endifif(oom_score_adj<selected_oom_score_adj)continue;if(oom_score_adj==selected_oom_score_adj&&tasksize<=selected_tasksize)continue;#ifdefCONFIG_SAMP_HOTNESS}else{if(hotness_adj>selected_hotness_adj)continue;if(hotness_adj==selected_hotness_adj&&tasksize<=selected_tasksize)continue;}#endif}selected=p;selected_tasksize=tasksize;selected_oom_score_adj=oom_score_adj;#ifdefCONFIG_SAMP_HOTNESSselected_hotness_adj=hotness_adj;#endiflowmem_print(2,"select%d(%s),adj%d,size%d,tokill\n",p->pid,p->comm,oom_score_adj,tasksize);}if(selected){#ifdefined(CONFIG_CMA_PAGE_COUNTING)#ifdefCONFIG_SAMP_HOTNESSlowmem_print(1,"sendsigkillto%d(%s),adj%d,size%d,""ofree%d,ofile%d(%c),is_kswapd%d-""cma_free%lupriority%dcma_i_file%lucma_a_file%lu,hotness%d\n",selected->pid,selected->comm,selected_oom_score_adj,selected_tasksize,other_free,other_file,flag?'-':'+',!!current_is_kswapd(),nr_cma_free,sc->priority,nr_cma_inactive_file,nr_cma_active_file,selected_hotness_adj);#elselowmem_print(1,"sendsigkillto%d(%s),adj%d,size%d,""ofree%d,ofile%d(%c),is_kswapd%d-""cma_free%lupriority%dcma_i_file%lucma_a_file%lu\n",selected->pid,selected->comm,selected_oom_score_adj,selected_tasksize,other_free,other_file,flag?'-':'+',!!current_is_kswapd(),nr_cma_free,sc->priority,nr_cma_inactive_file,nr_cma_active_file);#endif#else#ifdefCONFIG_SAMP_HOTNESSlowmem_print(1,"sendsigkillto%d(%s),adj%d,size%d,""freememory=%d,reclaimablememory=%d""is_kswapd%dcma_free%lupriority%d,hotness%d\n",selected->pid,selected->comm,selected_oom_score_adj,selected_tasksize,other_free,other_file,!!current_is_kswapd(),nr_cma_free,sc->priority,selected_hotness_adj);#elselowmem_print(1,"sendsigkillto%d(%s),adj%d,size%d,""freememory=%d,reclaimablememory=%d""is_kswapd%dcma_free%lupriority%d\n",selected->pid,selected->comm,selected_oom_score_adj,selected_tasksize,other_free,other_file,!!current_is_kswapd(),nr_cma_free,sc->priority);#endif#endiflowmem_deathpending_timeout=jiffies+HZ;send_sig(SIGKILL,selected,0);set_tsk_thread_flag(selected,TIF_MEMDIE);rem-=selected_tasksize;rcu_read_unlock();#ifdefLMK_COUNT_READlmk_count++;#endif#ifdefCONFIG_SEC_DEBUG_LMK_MEMINFOif((selected_oom_score_adj<lowmem_adj[5])&&__ratelimit(&lmk_rs)){lowmem_print(1,"lowmem_shrink%lu,%x,ofree%d%d,ma%d\n",nr_to_scan,sc->gfp_mask,other_free,other_file,min_score_adj);show_mem(SHOW_MEM_FILTER_NODES);dump_tasks_info();}#endif/*givethesystemtimetofreeupthememory*/msleep_interruptible(20);if(reclaim_state)reclaim_state->reclaimed_slab=selected_tasksize;}elsercu_read_unlock();lowmem_print(4,"lowmem_shrink%lu,%x,return%d\n",nr_to_scan,sc->gfp_mask,rem);mutex_unlock(&scan_mutex);returnrem;}/**CONFIG_SEC_OOM_KILLER:klaatu@sec**Thewaytoselectvictimbyoom-killerprovidedby*linuxkernelistotallydifferentfromandroidpolicy.*Hence,itmakesmoresensethatweselecttheoomvictim*asandroiddoeswhenLMKisinvoked.**/#ifdefCONFIG_SEC_OOM_KILLERstaticintandroid_oom_handler(structnotifier_block*nb,unsignedlongval,void*data){structtask_struct*tsk;#ifdefMULTIPLE_OOM_KILLERstructtask_struct*selected[OOM_DEPTH]={NULL,};#elsestructtask_struct*selected=NULL;#endifintrem=0;inttasksize;inti;intmin_score_adj=OOM_SCORE_ADJ_MAX+1;#ifdefMULTIPLE_OOM_KILLERintselected_tasksize[OOM_DEPTH]={0,};intselected_oom_score_adj[OOM_DEPTH]={OOM_ADJUST_MAX,};intall_selected_oom=0;intmax_selected_oom_idx=0;#elseintselected_tasksize=0;intselected_oom_score_adj;#endif#ifdefCONFIG_SEC_DEBUG_LMK_MEMINFOstaticDEFINE_RATELIMIT_STATE(oom_rs,DEFAULT_RATELIMIT_INTERVAL/5,1);#endifunsignedlong*freed=data;#ifdefined(CONFIG_CMA_PAGE_COUNTING)unsignedlongnr_cma_free;unsignedlongnr_cma_inactive_file;unsignedlongnr_cma_active_file;intother_free;intother_file;nr_cma_free=global_page_state(NR_FREE_CMA_PAGES);other_free=global_page_state(NR_FREE_PAGES)-nr_cma_free;nr_cma_inactive_file=global_page_state(NR_CMA_INACTIVE_FILE);nr_cma_active_file=global_page_state(NR_CMA_ACTIVE_FILE);other_file=global_page_state(NR_FILE_PAGES)-global_page_state(NR_SHMEM)-total_swapcache_pages-nr_cma_inactive_file-nr_cma_active_file;#endif/*showstatus*/pr_warning("%sinvokedAndroid-oom-killer:""oom_adj=%d,oom_score_adj=%d\n",current->comm,current->signal->oom_adj,current->signal->oom_score_adj);#ifdefCONFIG_SEC_DEBUG_LMK_MEMINFOif(__ratelimit(&oom_rs)){dump_stack();show_mem(SHOW_MEM_FILTER_NODES);dump_tasks_info();}#endifmin_score_adj=0;#ifdefMULTIPLE_OOM_KILLERfor(i=0;i<OOM_DEPTH;i++)selected_oom_score_adj[i]=min_score_adj;#elseselected_oom_score_adj=min_score_adj;#endifread_lock(&tasklist_lock);for_each_process(tsk){structtask_struct*p;intoom_score_adj;#ifdefMULTIPLE_OOM_KILLERintis_exist_oom_task=0;#endifif(tsk->flags&PF_KTHREAD)continue;p=find_lock_task_mm(tsk);if(!p)continue;oom_score_adj=p->signal->oom_score_adj;if(oom_score_adj<min_score_adj){task_unlock(p);continue;}tasksize=get_mm_rss(p->mm);task_unlock(p);if(tasksize<=0)continue;lowmem_print(2,"oom:------%d(%s),adj%d,size%d\n",p->pid,p->comm,oom_score_adj,tasksize);#ifdefMULTIPLE_OOM_KILLERif(all_selected_oom<OOM_DEPTH){for(i=0;i<OOM_DEPTH;i++){if(!selected[i]){is_exist_oom_task=1;max_selected_oom_idx=i;break;}}}elseif(selected_oom_score_adj[max_selected_oom_idx]<oom_score_adj||(selected_oom_score_adj[max_selected_oom_idx]==oom_score_adj&&selected_tasksize[max_selected_oom_idx]<tasksize)){is_exist_oom_task=1;}if(is_exist_oom_task){selected[max_selected_oom_idx]=p;selected_tasksize[max_selected_oom_idx]=tasksize;selected_oom_score_adj[max_selected_oom_idx]=oom_score_adj;if(all_selected_oom<OOM_DEPTH)all_selected_oom++;if(all_selected_oom==OOM_DEPTH){for(i=0;i<OOM_DEPTH;i++){if(selected_oom_score_adj[i]<selected_oom_score_adj[max_selected_oom_idx])max_selected_oom_idx=i;elseif(selected_oom_score_adj[i]==selected_oom_score_adj[max_selected_oom_idx]&&selected_tasksize[i]<selected_tasksize[max_selected_oom_idx])max_selected_oom_idx=i;}}lowmem_print(2,"oom:max_selected_oom_idx(%d)select%d(%s),adj%d,\size%d,tokill\n",max_selected_oom_idx,p->pid,p->comm,oom_score_adj,tasksize);}#elseif(selected){if(oom_score_adj<selected_oom_score_adj)continue;if(oom_score_adj==selected_oom_score_adj&&tasksize<=selected_tasksize)continue;}selected=p;selected_tasksize=tasksize;selected_oom_score_adj=oom_score_adj;lowmem_print(2,"oom:select%d(%s),adj%d,size%d,tokill\n",p->pid,p->comm,oom_score_adj,tasksize);#endif}#ifdefMULTIPLE_OOM_KILLERfor(i=0;i<OOM_DEPTH;i++){if(selected[i]){#ifdefined(CONFIG_CMA_PAGE_COUNTING)lowmem_print(1,"oom:sendsigkillto%d(%s),adj%d,""size%dofree%dofile%d""cma_free%lucma_i_file%lucma_a_file%lu\n",selected[i]->pid,selected[i]->comm,selected_oom_score_adj[i],selected_tasksize[i],other_free,other_file,nr_cma_free,nr_cma_inactive_file,nr_cma_active_file);#elselowmem_print(1,"oom:sendsigkillto%d(%s),adj%d,\size%d\n",selected[i]->pid,selected[i]->comm,selected_oom_score_adj[i],selected_tasksize[i]);#endifsend_sig(SIGKILL,selected[i],0);rem-=selected_tasksize[i];*freed+=(unsignedlong)selected_tasksize[i];#ifdefOOM_COUNT_READoom_count++;#endif}}#elseif(selected){lowmem_print(1,"oom:sendsigkillto%d(%s),adj%d,size%d\n",selected->pid,selected->comm,selected_oom_score_adj,selected_tasksize);send_sig(SIGKILL,selected,0);set_tsk_thread_flag(selected,TIF_MEMDIE);rem-=selected_tasksize;*freed+=(unsignedlong)selected_tasksize;#ifdefOOM_COUNT_READoom_count++;#endif}#endifread_unlock(&tasklist_lock);lowmem_print(2,"oom:getmemory%lu",*freed);returnrem;}staticstructnotifier_blockandroid_oom_notifier={.notifier_call=android_oom_handler,};#endif/*CONFIG_SEC_OOM_KILLER*/staticstructshrinkerlowmem_shrinker={.shrink=lowmem_shrink,.seeks=DEFAULT_SEEKS*16};staticint__initlowmem_init(void){register_shrinker(&lowmem_shrinker);#ifdefCONFIG_SEC_OOM_KILLERregister_oom_notifier(&android_oom_notifier);#endifreturn0;}staticvoid__exitlowmem_exit(void){unregister_shrinker(&lowmem_shrinker);}#ifdefCONFIG_ANDROID_LOW_MEMORY_KILLER_AUTODETECT_OOM_ADJ_VALUESstaticintlowmem_oom_adj_to_oom_score_adj(intoom_adj){if(oom_adj==OOM_ADJUST_MAX)returnOOM_SCORE_ADJ_MAX;elsereturn(oom_adj*OOM_SCORE_ADJ_MAX)/-OOM_DISABLE;}staticvoidlowmem_autodetect_oom_adj_values(void){inti;intoom_adj;intoom_score_adj;intarray_size=ARRAY_SIZE(lowmem_adj);if(lowmem_adj_size<array_size)array_size=lowmem_adj_size;if(array_size<=0)return;oom_adj=lowmem_adj[array_size-1];if(oom_adj>OOM_ADJUST_MAX)return;oom_score_adj=lowmem_oom_adj_to_oom_score_adj(oom_adj);if(oom_score_adj<=OOM_ADJUST_MAX)return;lowmem_print(1,"lowmem_shrink:convertoom_adjtooom_score_adj:\n");for(i=0;i<array_size;i++){oom_adj=lowmem_adj[i];oom_score_adj=lowmem_oom_adj_to_oom_score_adj(oom_adj);lowmem_adj[i]=oom_score_adj;lowmem_print(1,"oom_adj%d=>oom_score_adj%d\n",oom_adj,oom_score_adj);}}staticintlowmem_adj_array_set(constchar*val,conststructkernel_param*kp){intret;ret=param_array_ops.set(val,kp);/*HACK:Autodetectoom_adjvaluesinlowmem_adjarray*/lowmem_autodetect_oom_adj_values();returnret;}staticintlowmem_adj_array_get(char*buffer,conststructkernel_param*kp){returnparam_array_ops.get(buffer,kp);}staticvoidlowmem_adj_array_free(void*arg){param_array_ops.free(arg);}staticstructkernel_param_opslowmem_adj_array_ops={.set=lowmem_adj_array_set,.get=lowmem_adj_array_get,.free=lowmem_adj_array_free,};staticconststructkparam_array__param_arr_adj={.max=ARRAY_SIZE(lowmem_adj),.num=&lowmem_adj_size,.ops=&param_ops_int,.elemsize=sizeof(lowmem_adj[0]),.elem=lowmem_adj,};#endifmodule_param_named(cost,lowmem_shrinker.seeks,int,S_IRUGO|S_IWUSR);#ifdefCONFIG_ANDROID_LOW_MEMORY_KILLER_AUTODETECT_OOM_ADJ_VALUES__module_param_call(MODULE_PARAM_PREFIX,adj,&lowmem_adj_array_ops,.arr=&__param_arr_adj,S_IRUGO|S_IWUSR,-1);__MODULE_PARM_TYPE(adj,"arrayofint");#elsemodule_param_array_named(adj,lowmem_adj,int,&lowmem_adj_size,S_IRUGO|S_IWUSR);#endifmodule_param_array_named(minfree,lowmem_minfree,uint,&lowmem_minfree_size,S_IRUGO|S_IWUSR);module_param_named(debug_level,lowmem_debug_level,uint,S_IRUGO|S_IWUSR);#ifdefLMK_COUNT_READmodule_param_named(lmkcount,lmk_count,uint,S_IRUGO);#endif#ifdefOOM_COUNT_READmodule_param_named(oomcount,oom_count,uint,S_IRUGO);#endifmodule_init(lowmem_init);module_exit(lowmem_exit);MODULE_LICENSE("GPL");